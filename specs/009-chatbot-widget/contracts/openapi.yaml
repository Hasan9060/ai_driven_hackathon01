openapi: 3.0.3
info:
  title: Docusaurus RAG Chatbot API
  description: API for the RAG chatbot widget integrated with the Humanoid Robotics textbook
  version: 1.0.0
  contact:
    name: Chatbot Support
    email: support@example.com
  license:
    name: MIT

servers:
  - url: https://api.example.com/v1
    description: Production server
  - url: https://staging-api.example.com/v1
    description: Staging server
  - url: http://localhost:8000/v1
    description: Development server

paths:
  /chat:
    post:
      tags:
        - Chat
      summary: Send chat message
      description: Send a message to the chatbot and receive an AI-generated response
      operationId: sendMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              simple_question:
                summary: Simple question without context
                value:
                  message: "What is kinematics?"
                  session_id: "550e8400-e29b-41d4-a716-446655440000"
              with_selected_text:
                summary: Question with selected text context
                value:
                  message: "Explain this concept"
                  session_id: "550e8400-e29b-41d4-a716-446655440000"
                  selected_text: "Kinematics is the branch of classical mechanics that describes the motion of points, objects, and systems of groups of objects without considering the causes of motion."
                  context:
                    page_url: "https://example.com/intro/overview"
                    chapter: 1
                    section: "Introduction"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
              successful_response:
                summary: Successful chat response
                value:
                  answer: "Kinematics is the branch of classical mechanics that describes motion without considering the forces that cause it. It focuses on parameters like position, velocity, and acceleration."
                  sources:
                    - url: "https://example.com/intro/overview"
                      title: "Introduction to Kinematics"
                      snippet: "Kinematics is the branch of classical mechanics..."
                      relevance_score: 0.95
                      chapter: 1
                      section: "Introduction"
                  session_id: "550e8400-e29b-41d4-a716-446655440000"
                  message_id: "msg_123456789"
                  response_time_ms: 1250
                  confidence_score: 0.89
                  followup_suggestions:
                    - "What are the main types of kinematic motion?"
                    - "How is kinematics used in robotics?"
                  selected_text_used: false
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /chat/history:
    get:
      tags:
        - Chat
      summary: Get chat history
      description: Retrieve the conversation history for a specific session
      operationId: getChatHistory
      parameters:
        - name: session_id
          in: query
          required: true
          schema:
            type: string
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
          description: Maximum number of messages to return
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Number of messages to skip for pagination
      responses:
        '200':
          description: Successfully retrieved chat history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatHistoryResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /sessions:
    post:
      tags:
        - Sessions
      summary: Create new session
      description: Create a new chat session for the user
      operationId: createSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
            examples:
              new_session:
                summary: Create new session
                value:
                  user_identifier: "user_12345"
                  language_preference: "en"
                  context:
                    entry_page: "https://example.com/intro/overview"
                    referrer: "https://google.com"
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
              examples:
              created_session:
                summary: Successfully created session
                value:
                  session_id: "550e8400-e29b-41d4-a716-446655440000"
                  user_identifier: "user_12345"
                  created_at: "2025-12-17T17:30:00Z"
                  expires_at: "2026-01-16T17:30:00Z"
                  is_active: true
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /sessions/{session_id}:
    get:
      tags:
        - Sessions
      summary: Get session details
      description: Retrieve information about a specific chat session
      operationId: getSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Session details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Sessions
      summary: Delete session
      description: Delete a chat session and all associated data
      operationId: deleteSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Session deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteSessionResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /sessions/{session_id}/extend:
    post:
      tags:
        - Sessions
      summary: Extend session
      description: Extend the expiration time of a chat session
      operationId: extendSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: additional_hours
          in: query
          required: false
          schema:
            type: integer
            default: 24
            minimum: 1
            maximum: 168
          description: Additional hours to extend session
      responses:
        '200':
          description: Session extended successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check the health status of the chatbot service
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'

components:
  schemas:
    ChatRequest:
      type: object
      required:
        - message
        - session_id
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 1000
          description: User's message or question
          example: "What is kinematics?"
        session_id:
          type: string
          format: uuid
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        selected_text:
          type: string
          maxLength: 2000
          description: Optional selected text from the page for context
          example: "Kinematics is the branch of classical mechanics that describes the motion of points..."
        context:
          type: object
          properties:
            page_url:
              type: string
              format: uri
              description: Current page URL
              example: "https://example.com/intro/overview"
            chapter:
              type: integer
              description: Chapter number
              example: 1
            section:
              type: string
              description: Section title
              example: "Introduction"

    ChatResponse:
      type: object
      required:
        - answer
        - session_id
        - message_id
      properties:
        answer:
          type: string
          description: AI-generated answer
          example: "Kinematics is the branch of classical mechanics that describes motion without considering the forces that cause it."
        sources:
          type: array
          items:
            $ref: '#/components/schemas/Source'
          description: Source citations for the answer
        session_id:
          type: string
          format: uuid
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        message_id:
          type: string
          description: Unique message identifier
          example: "msg_123456789"
        response_time_ms:
          type: integer
          description: Time taken to generate response in milliseconds
          example: 1250
        confidence_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Confidence score of the answer
          example: 0.89
        followup_suggestions:
          type: array
          items:
            type: string
          description: Suggested follow-up questions
          example:
            - "What are the main types of kinematic motion?"
            - "How is kinematics used in robotics?"
        selected_text_used:
          type: boolean
          description: Whether selected text was used as context
          example: false

    Source:
      type: object
      required:
        - url
        - title
        - snippet
      properties:
        url:
          type: string
          format: uri
          description: Source URL
          example: "https://example.com/intro/overview"
        title:
          type: string
          description: Source title
          example: "Introduction to Kinematics"
        snippet:
          type: string
          description: Relevant text snippet from source
          example: "Kinematics is the branch of classical mechanics that describes..."
        relevance_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Relevance score of the source
          example: 0.95
        chapter:
          type: integer
          description: Chapter number
          example: 1
        section:
          type: string
          description: Section title
          example: "Introduction"

    CreateSessionRequest:
      type: object
      properties:
        user_identifier:
          type: string
          description: Optional user identifier for tracking
          example: "user_12345"
        language_preference:
          type: string
          default: "en"
          description: Language preference for responses
          example: "en"
        context:
          type: object
          properties:
            entry_page:
              type: string
              format: uri
              description: Entry page URL
              example: "https://example.com/intro/overview"
            referrer:
              type: string
              format: uri
              description: Referrer URL
              example: "https://google.com"

    SessionResponse:
      type: object
      required:
        - session_id
        - created_at
        - is_active
      properties:
        session_id:
          type: string
          format: uuid
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_identifier:
          type: string
          description: User identifier
          example: "user_12345"
        created_at:
          type: string
          format: date-time
          description: Session creation timestamp
          example: "2025-12-17T17:30:00Z"
        expires_at:
          type: string
          format: date-time
          description: Session expiration timestamp
          example: "2026-01-16T17:30:00Z"
        is_active:
          type: boolean
          description: Whether session is currently active
          example: true
        message_count:
          type: integer
          description: Number of messages in session
          example: 5
        last_activity:
          type: string
          format: date-time
          description: Last activity timestamp
          example: "2025-12-17T18:45:00Z"

    ChatHistoryResponse:
      type: object
      required:
        - messages
        - session_id
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'
          description: Array of chat messages
        session_id:
          type: string
          format: uuid
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        total_count:
          type: integer
          description: Total number of messages in session
          example: 15
        has_more:
          type: boolean
          description: Whether there are more messages available
          example: false

    ChatMessage:
      type: object
      required:
        - id
        - message_type
        - content
        - created_at
      properties:
        id:
          type: string
          description: Message identifier
          example: "msg_123456789"
        message_type:
          type: string
          enum: [question, answer, system]
          description: Type of message
          example: "question"
        content:
          type: string
          description: Message content
          example: "What is kinematics?"
        sources:
          type: array
          items:
            $ref: '#/components/schemas/Source'
          description: Source citations (for answer messages)
        confidence_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Confidence score (for answer messages)
          example: 0.89
        response_time_ms:
          type: integer
          description: Response time in milliseconds (for answer messages)
          example: 1250
        selected_text_context:
          type: string
          description: Selected text used as context
          example: "Kinematics is the branch of classical mechanics..."
        created_at:
          type: string
          format: date-time
          description: Message timestamp
          example: "2025-12-17T18:45:00Z"

    DeleteSessionResponse:
      type: object
      required:
        - session_id
        - deleted
      properties:
        session_id:
          type: string
          format: uuid
          description: Session identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        deleted:
          type: boolean
          description: Whether session was successfully deleted
          example: true
        messages_deleted:
          type: integer
          description: Number of messages deleted
          example: 12

    HealthCheckResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, unhealthy, degraded]
          description: Overall health status
          example: "healthy"
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
          example: "2025-12-17T18:45:00Z"
        services:
          type: object
          description: Health status of individual services
          properties:
            database:
              type: object
              properties:
                status:
                  type: string
                  enum: [healthy, unhealthy]
                  example: "healthy"
                response_time_ms:
                  type: number
                  example: 45
            cohere:
              type: object
              properties:
                status:
                  type: string
                  enum: [healthy, unhealthy]
                  example: "healthy"
                response_time_ms:
                  type: number
                  example: 234
            qdrant:
              type: object
              properties:
                status:
                  type: string
                  enum: [healthy, unhealthy]
                  example: "healthy"
                collection_size:
                  type: integer
                  example: 195
        uptime_seconds:
          type: number
          description: Service uptime in seconds
          example: 86400

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Error code
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: Error message
              example: "Message is required and cannot be empty"
            details:
              type: object
              description: Additional error details
              properties:
                field:
                  type: string
                  example: "message"
                constraint:
                  type: string
                  example: "min_length: 1"
        request_id:
          type: string
          description: Request identifier for debugging
          example: "req_123456789"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []